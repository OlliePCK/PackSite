<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - The Pack</title>
    <link rel="icon" type="image/svg+xml" href="/img/pck.svg?v=2">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ff006a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Pack">
    <link rel="apple-touch-icon" href="/img/pck-192.png">
    <link rel="stylesheet" href="/styles.css">
    <script src="/nav.js" defer></script>
    <style>
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
        }
        .profile-info {
            text-align: left;
        }
        .profile-name {
            font-size: 1.5em;
            font-weight: bold;
        }
        .profile-stats-summary {
            color: var(--text-secondary);
            margin-top: 5px;
        }
        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 0, 106, 0.2);
            border: 1px solid var(--primary);
            border-radius: 20px;
            font-size: 0.85em;
        }
        .badge-icon {
            font-size: 1.1em;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary);
        }
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-top: 5px;
        }
        .section-title {
            font-size: 1.1em;
            margin: 25px 0 15px 0;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .track-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }
        .track-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .track-rank {
            width: 30px;
            font-weight: bold;
            color: var(--primary);
        }
        .track-thumbnail {
            width: 45px;
            height: 45px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-dark);
        }
        .track-info {
            flex: 1;
            min-width: 0;
            text-align: left;
        }
        .track-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-meta {
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        .recent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .recent-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-dark);
        }
        .recent-info {
            flex: 1;
            min-width: 0;
            text-align: left;
        }
        .recent-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95em;
        }
        .recent-time {
            color: var(--text-secondary);
            font-size: 0.8em;
            white-space: nowrap;
        }
        .two-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .column-section {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            padding: 15px;
        }
        .column-title {
            font-size: 1em;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
    </style>
</head>

<body>
    <canvas id="neuro"></canvas>
    
    <!-- Navigation -->
    <nav class="navbar">
        <a href="/" class="nav-logo">
            <img src="/img/texture.svg" alt="Pack Logo" class="nav-logo-img">
        </a>
        <button class="hamburger" id="hamburger" aria-label="Toggle navigation">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
        <div class="nav-links" id="nav-links">
            <a href="/" class="nav-link">Home</a>
            <a href="/dashboard.html" class="nav-link">Dashboard</a>
            <a href="/nowplaying.html" class="nav-link">Now Playing</a>
            <a href="/leaderboard.html" class="nav-link">Leaderboard</a>
            <a href="/history.html" class="nav-link">History</a>
            <a href="/youtube.html" class="nav-link">YouTube</a>
            <a href="/monitors.html" class="nav-link">Monitors</a>
            <a href="/shopify.html" class="nav-link">Shopify</a>
            <!-- Mobile-only items -->
            <div class="mobile-nav-divider" id="mobile-divider"></div>
            <div class="mobile-user-info" id="mobile-user-info">
                <img class="user-avatar" id="mobile-user-avatar" alt="Avatar">
                <span id="mobile-user-name"></span>
            </div>
            <a href="/settings.html" class="mobile-nav-item" id="mobile-settings">‚öôÔ∏è Settings</a>
            <a href="#" class="mobile-nav-item" id="mobile-logout">üö™ Logout</a>
            <a href="#" class="mobile-login-btn" id="mobile-login">Login with Discord</a>
        </div>
        <div class="nav-auth" id="nav-auth">
            <a href="#" id="login-btn" class="nav-btn">Login with Discord</a>
            <div id="user-info" class="user-info hidden">
                <div class="user-info-toggle">
                    <img id="user-avatar" class="user-avatar" alt="Avatar" crossorigin="anonymous">
                    <span id="user-name"></span>
                    <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="user-dropdown">
                    <div class="user-dropdown-inner">
                        <a href="/settings.html" class="dropdown-item">
                            <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                            Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" id="logout-btn">
                            <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="page-container">
        <!-- Not Logged In State -->
        <div id="not-logged-in" class="card">
            <div class="empty-state">
                <div class="empty-state-icon">üîê</div>
                <h3>Login Required</h3>
                <p>Please login with Discord to view profiles</p>
                <a href="#" onclick="packBotAPI.login(); return false;" class="nav-btn" style="display: inline-block; margin-top: 20px;">
                    Login with Discord
                </a>
            </div>
        </div>

        <!-- Profile Content -->
        <div id="profile-content" class="hidden">
            <!-- Guild Filter -->
            <div class="card">
                <h2 class="card-title">Filter by Server</h2>
                <select id="guild-select" style="width: 100%; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                    <option value="">All Servers</option>
                </select>
            </div>

            <!-- Profile Card -->
            <div class="card" id="profile-card" style="display: none;">
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar">üë§</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profile-name">Loading...</div>
                        <div class="profile-stats-summary" id="profile-summary"></div>
                    </div>
                </div>

                <!-- Badges -->
                <div class="badges-container" id="badges-container"></div>

                <!-- Stats -->
                <div class="stats-grid" style="margin-top: 25px;">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-tracks">0</div>
                        <div class="stat-label">Tracks Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-time">0h</div>
                        <div class="stat-label">Listening Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-servers">0</div>
                        <div class="stat-label">Servers Active</div>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div class="two-columns">
                    <!-- Top Tracks -->
                    <div class="column-section">
                        <div class="column-title">üéµ Top Tracks</div>
                        <div id="top-tracks-list"></div>
                    </div>

                    <!-- Top Artists -->
                    <div class="column-section">
                        <div class="column-title">üé§ Top Artists</div>
                        <div id="top-artists-list"></div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="section-title">üìÖ Recent Activity</div>
                <div id="recent-plays-list"></div>
            </div>

            <!-- No Data State -->
            <div id="no-data" class="card" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">üéß</div>
                    <h3>No Listening Data</h3>
                    <p>This user hasn't played any music yet!</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/main.js"></script>
    <script src="/api.js?v=3"></script>
    <script>
        let profileUserId = null;
        let currentGuildId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await waitForAuth();
        });

        async function waitForAuth() {
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const me = await packBotAPI.getMe();
            if (me && me.authenticated) {
                document.getElementById('not-logged-in').classList.add('hidden');
                document.getElementById('profile-content').classList.remove('hidden');
                
                // Get user ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                profileUserId = urlParams.get('user') || me.id;
                currentGuildId = urlParams.get('guild') || null;
                
                await loadGuilds();
                loadProfile();
            }
        }

        async function loadGuilds() {
            try {
                const res = await fetch('/api/guilds', { credentials: 'include' });
                const data = await res.json();

                if (data.guilds && data.guilds.length > 0) {
                    const select = document.getElementById('guild-select');
                    data.guilds.forEach(guild => {
                        const option = document.createElement('option');
                        option.value = guild.id;
                        option.textContent = guild.name;
                        if (guild.id === currentGuildId) option.selected = true;
                        select.appendChild(option);
                    });

                    select.addEventListener('change', (e) => {
                        currentGuildId = e.target.value || null;
                        loadProfile();
                    });
                }
            } catch (error) {
                console.error('Failed to load guilds:', error);
            }
        }

        async function loadProfile() {
            if (!profileUserId) return;

            try {
                const profile = await packBotAPI.getProfile(profileUserId, currentGuildId);
                
                if (!profile || profile.stats.totalTracks === 0) {
                    document.getElementById('profile-card').style.display = 'none';
                    document.getElementById('no-data').style.display = 'block';
                    return;
                }

                document.getElementById('profile-card').style.display = 'block';
                document.getElementById('no-data').style.display = 'none';

                // Update header
                document.getElementById('profile-name').textContent = profile.username;
                document.getElementById('profile-avatar').textContent = profile.username.charAt(0).toUpperCase();
                document.getElementById('profile-summary').textContent = 
                    `${formatNumber(profile.stats.totalTracks)} tracks ‚Ä¢ ${formatListeningTime(profile.stats.totalListeningTime)} of music`;

                // Update stats
                document.getElementById('stat-tracks').textContent = formatNumber(profile.stats.totalTracks);
                document.getElementById('stat-time').textContent = formatListeningTime(profile.stats.totalListeningTime);
                document.getElementById('stat-servers').textContent = profile.stats.guildsActive;

                // Render badges
                const badgesContainer = document.getElementById('badges-container');
                badgesContainer.innerHTML = profile.badges.map(badge => `
                    <div class="badge" title="${badge.desc}">
                        <span class="badge-icon">${badge.icon}</span>
                        <span>${badge.name}</span>
                    </div>
                `).join('') || '<span style="color: var(--text-secondary);">No badges yet</span>';

                // Render top tracks
                const topTracksList = document.getElementById('top-tracks-list');
                topTracksList.innerHTML = profile.topTracks.slice(0, 5).map((track, i) => `
                    <div class="track-item">
                        <div class="track-rank">#${i + 1}</div>
                        <img class="track-thumbnail" src="${track.thumbnail || '/img/pck.svg'}" alt="" onerror="this.src='/img/pck.svg'">
                        <div class="track-info">
                            <div class="track-title">${escapeHtml(track.title)}</div>
                            <div class="track-meta">${track.playCount} plays</div>
                        </div>
                    </div>
                `).join('') || '<p style="color: var(--text-secondary);">No data yet</p>';

                // Render top artists
                const topArtistsList = document.getElementById('top-artists-list');
                topArtistsList.innerHTML = profile.topArtists.slice(0, 5).map((artist, i) => `
                    <div class="track-item">
                        <div class="track-rank">#${i + 1}</div>
                        <div class="track-info">
                            <div class="track-title">${escapeHtml(artist.artist)}</div>
                            <div class="track-meta">${artist.playCount} plays</div>
                        </div>
                    </div>
                `).join('') || '<p style="color: var(--text-secondary);">No data yet</p>';

                // Render recent plays
                const recentPlaysList = document.getElementById('recent-plays-list');
                recentPlaysList.innerHTML = profile.recentPlays.map(play => `
                    <div class="recent-item">
                        <img class="recent-thumbnail" src="${play.thumbnail || '/img/pck.svg'}" alt="" onerror="this.src='/img/pck.svg'">
                        <div class="recent-info">
                            <div class="recent-title">${escapeHtml(play.title)}</div>
                            <div class="track-meta">${play.artist ? escapeHtml(play.artist) + ' ‚Ä¢ ' : ''}${formatDuration(play.durationSeconds)}</div>
                        </div>
                        <div class="recent-time">${formatTimeAgo(play.playedAt)}</div>
                    </div>
                `).join('') || '<p style="color: var(--text-secondary);">No recent activity</p>';

            } catch (error) {
                console.error('Failed to load profile:', error);
                document.getElementById('profile-card').style.display = 'none';
                document.getElementById('no-data').style.display = 'block';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatListeningTime(seconds) {
            if (!seconds) return '0m';
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = (now - date) / 1000;
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
            return date.toLocaleDateString();
        }
    </script>
</body>
</html>
